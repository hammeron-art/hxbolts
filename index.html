<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-dark.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>hxbolts by restorer</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <img src="images/hxbolts-logo.png" alt="" class="logo" />
          <h1>hxbolts</h1>
          <h2>Deal with async tasks like a boss</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/restorer/hxbolts/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/restorer/hxbolts/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/restorer/hxbolts" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <p>hxbolts is a port of a "tasks" component from java library named Bolts.
A task is kind of like a JavaScript Promise, but with different API.</p>

<p>While original java library is about keeping long-running operations out of the UI thread,
current version of hxbolts is more about transforming async callback hell into nice looking code.</p>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installation</h2>

<pre><code>haxelib install hxbolts
</code></pre>

<h2>
<a id="lets-talk" class="anchor" href="#lets-talk" aria-hidden="true"><span class="octicon octicon-link"></span></a>Let's talk</h2>

<p>Imagine you have to delete all comments from blog while player playing in your game, mwahahaha <g-emoji alias="smiling_imp" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f608.png">ðŸ˜ˆ</g-emoji> . But server API has only 4 methods:</p>

<ol>
<li>Authorize;</li>
<li>Get all posts ids;</li>
<li>Get all comments ids for specific post;</li>
<li>Delete specific comment by id.</li>
</ol>

<p>Let you have a function for making async requests:</p>

<div class="highlight highlight-haxe"><pre><span class="pl-k">private</span> <span class="pl-k">static</span> <span class="pl-k">function</span> <span class="pl-en">makeRequestAsync</span>(
    url : <span class="pl-c1">String</span>,
    callback : <span class="pl-c1">String</span> <span class="pl-k">-</span><span class="pl-k">&gt;</span> <span class="pl-c1">Void</span>
) : <span class="pl-c1">Void</span> { <span class="pl-k">...</span> }</pre></div>

<p>Usually code will look like:</p>

<div class="highlight highlight-haxe"><pre><span class="pl-k">var</span> <span class="pl-en">token</span> : <span class="pl-c1">String</span> <span class="pl-k">=</span> <span class="pl-c1">null</span>;

makeRequestAsync(<span class="pl-s"><span class="pl-pds">"</span>http://blog.tld/api/authorize?user=me<span class="pl-pds">"</span></span>, <span class="pl-k">function</span>(result : <span class="pl-c1">String</span>) : <span class="pl-c1">Void</span> {
    <span class="pl-k">try</span> {
        token <span class="pl-k">=</span> <span class="pl-c1">Reflect.</span>field(<span class="pl-c1">Json.</span>parse(result), <span class="pl-s"><span class="pl-pds">"</span>token<span class="pl-pds">"</span></span>);
    } <span class="pl-k">catch</span> (e : <span class="pl-c1">Dynamic</span>) {
        <span class="pl-k">trace</span>(<span class="pl-s"><span class="pl-pds">"</span>Error occurred : <span class="pl-pds">"</span></span> <span class="pl-k">+</span> <span class="pl-c1">Std.</span>string(e));
        <span class="pl-k">return</span>;
    }

    makeRequestAsync(<span class="pl-s"><span class="pl-pds">'</span>http://blog.tld/api/postsIds?token=<span class="pl-smi">${token}</span><span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(result : <span class="pl-c1">String</span>) : <span class="pl-c1">Void</span> {
        <span class="pl-k">var</span> ids : <span class="pl-c1">Array</span><span class="pl-k">&lt;</span><span class="pl-c1">Int</span><span class="pl-k">&gt;</span>;

        <span class="pl-k">try</span> {
            ids <span class="pl-k">=</span> <span class="pl-k">cast</span> <span class="pl-c1">Json.</span>parse(result);
        } <span class="pl-k">catch</span> (e : <span class="pl-c1">Dynamic</span>) {
            <span class="pl-k">trace</span>(<span class="pl-s"><span class="pl-pds">"</span>Error occurred : <span class="pl-pds">"</span></span> <span class="pl-k">+</span> <span class="pl-c1">Std.</span>string(e));
            <span class="pl-k">return</span>;
        }

        <span class="pl-k">var</span> results <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">Array</span><span class="pl-k">&lt;</span><span class="pl-c1">String</span><span class="pl-k">&gt;</span>();

        <span class="pl-k">for</span> (id in ids) {
            makeRequestAsync(<span class="pl-s"><span class="pl-pds">'</span>http://blog.tld/api/commentsIds?token=<span class="pl-smi">${token}</span>&amp;postId=<span class="pl-smi">${id}</span><span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(result : <span class="pl-c1">String</span>) : <span class="pl-c1">Void</span> {
                results.push(result);

                <span class="pl-k">if</span> (results.length <span class="pl-k">==</span> ids.length) {
                    <span class="pl-c">// ...</span>
                }
            });
        }
    });
});</pre></div>

<p>Uh oh... And I donâ€™t even started deletion process.</p>

<h2>
<a id="hxbolts-coming-to-the-rescue" class="anchor" href="#hxbolts-coming-to-the-rescue" aria-hidden="true"><span class="octicon octicon-link"></span></a>hxbolts coming to the rescue!</h2>

<p>At first we need to <em>boltify</em> makeRequestAsync function:</p>

<div class="highlight highlight-haxe"><pre><span class="pl-k">private</span> <span class="pl-k">static</span> <span class="pl-k">function</span> <span class="pl-en">makeRequestTask</span>(url : <span class="pl-c1">String</span>) : <span class="pl-c1">Task</span>&lt;<span class="pl-c1">String</span>&gt; {
    <span class="pl-k">var</span> tcs <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">TaskCompletionSource</span><span class="pl-k">&lt;</span><span class="pl-c1">String</span><span class="pl-k">&gt;</span>();

    makeRequestAsync(url, <span class="pl-k">function</span>(result : <span class="pl-c1">String</span>) : <span class="pl-c1">Void</span> {
        tcs.setResult(result);
    });

    <span class="pl-k">return</span> tcs.task;
}</pre></div>

<p>The rest is easy:</p>

<div class="highlight highlight-haxe"><pre><span class="pl-k">var</span> <span class="pl-en">token</span> : <span class="pl-c1">String</span> <span class="pl-k">=</span> <span class="pl-c1">null</span>;

makeRequestTask(<span class="pl-s"><span class="pl-pds">"</span>http://blog.tld/api/authorize?user=me<span class="pl-pds">"</span></span>).onSuccessTask(<span class="pl-k">function</span>(task : <span class="pl-c1">Task</span><span class="pl-k">&lt;</span><span class="pl-c1">String</span><span class="pl-k">&gt;</span>) : <span class="pl-c1">Task</span><span class="pl-k">&lt;</span><span class="pl-c1">String</span><span class="pl-k">&gt;</span> {
    token <span class="pl-k">=</span> <span class="pl-c1">Reflect.</span>field(<span class="pl-c1">Json.</span>parse(task.result), <span class="pl-s"><span class="pl-pds">"</span>token<span class="pl-pds">"</span></span>);
    <span class="pl-k">return</span> makeRequestTask(<span class="pl-s"><span class="pl-pds">'</span>http://blog.tld/api/postsIds?token=<span class="pl-smi">${token}</span><span class="pl-pds">'</span></span>);
}).onSuccessTask(<span class="pl-k">function</span>(task : <span class="pl-c1">Task</span><span class="pl-k">&lt;</span><span class="pl-c1">String</span><span class="pl-k">&gt;</span>) : <span class="pl-c1">Task</span><span class="pl-k">&lt;</span><span class="pl-c1">Array</span><span class="pl-k">&lt;</span><span class="pl-c1">String</span><span class="pl-k">&gt;&gt;</span> {
    <span class="pl-k">var</span> tasks <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">Array</span><span class="pl-k">&lt;</span><span class="pl-c1">Task</span><span class="pl-k">&lt;</span><span class="pl-c1">String</span><span class="pl-k">&gt;&gt;</span>();

    <span class="pl-k">for</span> (id in (<span class="pl-k">cast</span> <span class="pl-c1">Json.</span>parse(task.result) : <span class="pl-c1">Array</span><span class="pl-k">&lt;</span><span class="pl-c1">Int</span><span class="pl-k">&gt;</span>)) {
        tasks.push(makeRequestTask(<span class="pl-s"><span class="pl-pds">'</span>http://blog.tld/api/commentsIds?token=<span class="pl-smi">${token}</span>&amp;postId=<span class="pl-smi">${id}</span><span class="pl-pds">'</span></span>));
    }

    <span class="pl-k">return</span> <span class="pl-c1">Task.</span>whenAllResult(tasks);
}).onSuccessTask(<span class="pl-k">function</span>(task : <span class="pl-c1">Task</span><span class="pl-k">&lt;</span><span class="pl-c1">Array</span><span class="pl-k">&lt;</span><span class="pl-c1">String</span><span class="pl-k">&gt;&gt;</span>) : <span class="pl-c1">Task</span><span class="pl-k">&lt;</span><span class="pl-c1">Nothing</span><span class="pl-k">&gt;</span> {
    <span class="pl-k">var</span> tasks <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">Array</span><span class="pl-k">&lt;</span><span class="pl-c1">Task</span><span class="pl-k">&lt;</span><span class="pl-c1">String</span><span class="pl-k">&gt;&gt;</span>();

    <span class="pl-k">for</span> (response in task.result) {
        <span class="pl-k">for</span> (id in (<span class="pl-k">cast</span> <span class="pl-c1">Json.</span>parse(response) : <span class="pl-c1">Array</span><span class="pl-k">&lt;</span><span class="pl-c1">Int</span><span class="pl-k">&gt;</span>)) {
            tasks.push(makeRequestTask(<span class="pl-s"><span class="pl-pds">'</span>http://blog.tld/api/deleteComment?token=<span class="pl-smi">${token}</span>&amp;commentId=<span class="pl-smi">${id}</span><span class="pl-pds">'</span></span>));
        }
    }

    <span class="pl-k">return</span> <span class="pl-c1">Task.</span>whenAll(tasks);
}).continueWith(<span class="pl-k">function</span>(task : <span class="pl-c1">Task</span><span class="pl-k">&lt;</span><span class="pl-c1">Nothing</span><span class="pl-k">&gt;</span>) : <span class="pl-c1">Nothing</span> {
    <span class="pl-k">if</span> (task.isSuccessed) {
        <span class="pl-k">trace</span>(<span class="pl-s"><span class="pl-pds">"</span>Everything is good<span class="pl-pds">"</span></span>);
    } <span class="pl-k">else</span> {
        <span class="pl-k">trace</span>(<span class="pl-s"><span class="pl-pds">"</span>Error occurred : <span class="pl-pds">"</span></span> <span class="pl-k">+</span> <span class="pl-c1">Std.</span>string(task.error));
    }

    <span class="pl-k">return</span> <span class="pl-c1">null</span>;
});</pre></div>

<p>Code is linear, easy to understand. It even doesnâ€™t contains try / catch blocks, because hxbolts will take care about exceptions.</p>

<p>Check out more examples at <a href="https://github.com/restorer/hxbolts">hxbolts repo</a>.</p>
        </section>

        <footer>
          hxbolts is maintained by <a href="https://github.com/restorer">restorer</a><br>
          This page was generated by <a href="https://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Long</a>.
        </footer>


      </div>
    </div>
  </body>
</html>
